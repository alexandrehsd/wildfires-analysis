---
title: "WildFires Analysis - Exploratory Data Analysis"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

```{r warning=FALSE}
# Loading packages
library(pryr) # Memory usage information
library(lubridate) # date manipulation
library(dplyr) # data manipulation
library(tidyr) # data manipulation
library(ggplot2) # graphics
library(directlabels) # End lines legend for ggplot line plots
library(plotly) # Interactive graphics
library(stringr) # string manipulation
library(stringi) # remove diacritics
library(ggfortify)
library(rjson) # read json
library(nasapower) # nasapower api data
library(ggsci) # Scientific color palletes
library(zoo) # Replace NAs in time series analysis
library(rgdal) # Work with geo-spatial data
library(sf) # geo-spatial vector data
library(TSA) # Time Series Analys
library(qwraps2)# for pretty summary statistics
```


There are 4 csv files containing data about the fires of all ocurrences around all brazilian territory. Each file has data between 1st Sept to 30th Sept of each year from 2015 to 2019.

```{r}
temp <- list.files(path = "./database/modis_15-19", pattern = "*.csv")
myfiles = lapply(paste0("./database/modis_15-19/", temp), read.csv)

data <- bind_rows(myfiles)

rm(temp)
rm(myfiles)
```

there are 885117 observations in our dataset which sums up to 70 MB of storaged data.

```{r}
str(data)
```


```{r}
summary(data)
```

In order to print a well formatted table of summary statistics, lets write a function to do it

```{r}
options(qwraps2_markup = "latex")
my_summary <-
  list("diasemchuva" =
       list("min" = ~ min(.data$diasemchuva, na.rm = T),
            "mediana" = ~ qwraps2::median_iqr(.data$diasemchuva, na_rm = T),
            "média (desv. padr.)" = ~ qwraps2::mean_sd(.data$diasemchuva, na_rm = T),
            "máx" = ~ max(.data$diasemchuva, na.rm = T)),
       "precipitacao" =
       list("min" = ~ min(.data$precipitacao, na.rm = T),
            "mediana" = ~ qwraps2::median_iqr(.data$precipitacao, na_rm = T),
            "média (desv. padr.)" = ~ qwraps2::mean_sd(.data$precipitacao, na_rm = T),
            "máx" = ~ max(.data$precipitacao, na.rm = T)),
       "riscofogo" =
       list("min" = ~ min(.data$riscofogo, na.rm = T),
            "mediana" = ~ qwraps2::median_iqr(.data$riscofogo, na_rm = T),
            "média (desv. padr.)" = ~ qwraps2::mean_sd(.data$riscofogo, na_rm = T),
            "máx" = ~ max(.data$riscofogo, na.rm = T)),
       "frp" =
       list("min" = ~ min(.data$frp, na.rm = T),
            "mediana" = ~ qwraps2::median_iqr(.data$frp, na_rm = T),
            "média (desv. padr.)" = ~ qwraps2::mean_sd(.data$frp, na_rm = T),
            "máx" = ~ max(.data$frp, na.rm = T)),
       "Bioma" =
       list("Amazônia" = ~ qwraps2::n_perc0(.data$bioma == 'Amazonia'),
            "Cerrado"  = ~ qwraps2::n_perc0(.data$bioma == 'Cerrado'),
            "Mata Atlântica"  = ~ qwraps2::n_perc0(.data$bioma == 'Mata Atlantica'),
            "Pantanal"  = ~ qwraps2::n_perc0(.data$bioma == 'Pantanal'),
            "Caatinga"  = ~ qwraps2::n_perc0(.data$bioma == 'Caatinga'),
            "Pampa"  = ~ qwraps2::n_perc0(.data$bioma == 'Pampa')
       )
)

### Overall - output is a latex text
pretty_summary <- summary_table(data, my_summary)

```

Aparentemente, A coluna de área industrial e FRP tem poucas entradas não nulas

```{r}
total_records <- nrow(data)

noWeatherInfo <- is.na(data$diasemchuva)
noFrpInfo <- is.na(data$frp)

paste("Percentage of NAs entries on `FRP` =",
      round(100 * sum(noFrpInfo) / total_records, 2), "%")

paste("Percentage of NAs entries on `diasemchuva` =",
      round(100 * (sum(noWeatherInfo)) / total_records, 2), "%")

```

By the last results, it is possible that the number of days with no rain have a huge impact over the fires triggers.

we can also investigate another columns that have either redundant data or not useful data.

```{r}
levels(data$pais)
levels(data$satelite)

data$pais <- NULL
data$satelite <- NULL

object_size(data)
```

By looking at the structure of our dataframe, it becomes clear that the `datahora` is a datetime object not a Factor.

```{r}
data$datahora <- ymd_hms(str_replace_all(data$datahora,"/","-"))

levels(data$bioma)
```

We have 6 distincts biomas on our dataset. Perhaps, by knowing how is the distribution of fires among different biomas, we can refine our research.

```{r}
counts <- table(data$bioma)
counts

proportions <- 100 * counts / sum(counts)
proportions
```

As we can see, Amazonia represents around half of our dataset. In addition, the number of fire occurrences is very much like the proportion of land that each bioma has in brazilian territory.

-------------------------- Visualisations -----------------------------

```{r, fig.width = 4, fig.height= 3}
# For text in plots see
# http://r-statistics.co/Complete-Ggplot2-Tutorial-Part2-Customizing-Theme-With-R-Code.html

# For legend in plots see
# https://www.datanovia.com/en/blog/ggplot-legend-title-position-and-labels/

path_ch4 <- "/home/alexandre/Documentos/tcc/images/plots_cap4/"

proportions <- data %>% group_by(bioma) %>% summarise(n = round(100*n()/nrow(.), 1))

quantities <- as.character(sort(desc(proportions$n)))

ggplot(proportions, aes(x = reorder(bioma, -n), y = n, fill = bioma)) + 
    geom_bar(stat = "identity") +
    coord_flip() +
    scale_fill_manual(values = c("#ff5a00", "#999999",  "#ffce00", "#999999", "#999999", "#999999")) +
    labs(title="Proporção de observações por Bioma", y="Proporção %", x="Bioma", caption="Fonte: Elaborado pelo Autor") +
    theme(plot.title=element_text(size=10, 
                                      face="bold", 
                                      family="Arial",
                                      hjust=0.5,
                                      lineheight=1.2),  # title
              plot.subtitle=element_text(size=10, 
                                         family="Arial",
                                         face="bold",
                                         hjust=0.5),  # subtitle
              axis.title.x=element_text(size=8),  # X axis title
              axis.title.y=element_text(size=8),  # Y axis title
              axis.text.x=element_text(size=6,
                                       vjust=.5),  # X axis text
              axis.text.y=element_text(size=6),
              legend.title = element_blank(),
              legend.position = "none",
              plot.caption = element_text(size = 6)) # Y axis text
              # ggsave(paste0(path_ch4, "bioma-proportions.png"), dpi = "retina", width = 10, height = 8, units = "cm")

```

----------------------- DETECTING SEASONALITY

```{r}
data %>% 
  mutate(date = date(datahora)) %>% 
  group_by(date) %>% 
  ggplot(aes(x = date, group = 1)) +
   geom_freqpoly(stat = "count") +
   scale_x_date(date_breaks = "6 months", date_labels = "%b/%y") +
   labs(y = "Quantidade de incêndios", x = "Mês/Ano", title = 'Quantidade de incêndios por dia',  caption="Fonte: Elaborado pelo Autor") +
    theme(plot.title=element_text(size=10, 
                                      face="bold", 
                                      family="Arial",
                                      hjust=0.5,
                                      lineheight=1.2),  # title
              plot.subtitle=element_text(size=10, 
                                         family="Arial",
                                         face="bold",
                                         hjust=0.5),  # subtitle
              axis.title.x=element_text(size=8),  # X axis title
              axis.title.y=element_text(size=8),  # Y axis title
              axis.text.x=element_text(size=6,
                                       vjust=.5),  # X axis text
              axis.text.y=element_text(size=6),
              legend.title = element_blank(),
              legend.position = "none",
              plot.caption = element_text(size = 8)) # Y axis text
              # ggsave(paste0(path_ch4, "count-byDay.png"), dpi = "retina", width = 10, height = 8, units = "cm")
```

As we can see above, our data presents strong patterns (seasonality). By doing a Fourier Transform, it is possible get to know what are the main frequencies of this time series.

```{r}
sinal_INPE <- data %>% 
  mutate(date = date(datahora)) %>% 
  group_by(date) %>%
  summarise(n = n())

p <- periodogram(sinal_INPE$n, plot = F)

dd = data.frame(freq=p$freq, spec=p$spec)
order = dd[order(-dd$spec),]
top3 = head(order, 3)

# frequências com 3 maiores potências
top3
```

```{r}
time <- 1/top3$freq
time
```

```{r}

freqs <- dd %>% arrange(desc(dd$spec)) %>% filter(freq <= 0.1)

freqs %>% ggplot(mapping = aes(x = freq, y = spec)) +
  geom_bar(stat = "identity") +
  labs(y = "Potência", x = "Frequência (Hz)", title = 'Densidade Espectral de Potência',      caption="Fonte: Elaborado pelo Autor") +
  theme(plot.title=element_text(size=10, 
                                      face="bold", 
                                      family="Arial",
                                      hjust=0.5,
                                      lineheight=1.2),  # title
              plot.subtitle=element_text(size=10, 
                                         family="Arial",
                                         face="bold",
                                         hjust=0.5),  # subtitle
              axis.title.x=element_text(size=8),  # X axis title
              axis.title.y=element_text(size=8),  # Y axis title
              axis.text.x=element_text(size=6,
                                       vjust=.5),  # X axis text
              axis.text.y=element_text(size=6),
              legend.title = element_blank(),
              legend.position = "none",
              plot.caption = element_text(size = 8)) # Y axis text
              # ggsave(paste0(path_ch4, "psd.png"), dpi = "retina", width = 10, height = 8, units = "cm")
```

Therefore, the seasonality of our dataset is given by annualy, semesterly and quaterly periods. For reference, see https://anomaly.io/detect-seasonality-using-fourier-transform-r/index.html and http://www.di.fc.ul.pt/~jpn/r/fourier/fourier.html

Now, it is also important to get the underlying trend of the number of fire ocurrences through the months of the year. Let's start exploring this idea:

```{r}

# Capitalizes names

capitalize <- function(x) {
  s <- strsplit(x, " ")[[1]]
  paste(toupper(substring(s, 1,1)), substring(s, 2),
      sep="", collapse=" ")
}

levels <- c("Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez")

temp <- data %>% 
  transmute(mes = factor(sapply(substr(months(data$datahora), 1, 3), capitalize), levels = levels),
         ano = factor(year(datahora))) %>%
  group_by(ano, mes)

cold_dfs <- list()
for (i in 1:5) {
  cold_dfs[[i]] <- temp %>% 
    filter(!mes %in% c("Jan", "Fev", "Mar", "Abr", "Mai", "Dez"), ano == (i + 2014))
  cold_dfs[[i]]$color <- paste0("cold", i)
}

hot_dfs <- list()
for (i in 1:5) {
  hot_dfs[[i]] <- temp %>% 
    filter(!mes %in% c("Jun", "Jul", "Ago", "Set", "Out", "Nov"), ano == (i + 2014))
  hot_dfs[[i]]$color <- paste0("hot", i)
}

colors_df <- bind_rows(cold_dfs, hot_dfs) %>% 
  group_by(ano, mes, color) %>% 
  summarise(n = n()) %>% 
  mutate(ano_abb = as.factor(as.numeric(as.character(ano)) %% 2000))

dodge <- position_dodge(width = 0.9)

colors_df %>%
  ggplot(aes(x = mes, y = n)) +
  geom_bar(stat = "identity", position = dodge, aes(fill = color)) +
  # geom_text(aes(label = ano_abb), position = dodge,
            # size = 1.5, inherit.aes = T) +
  scale_colour_manual("Ano", values = c(cold1 = "#b7a8c1", cold2 = "#c7b4cc", 
                                        cold3 ="#d7c0d7", cold4 = "#e7cce2", cold5 = "#f7d8ed",
                                        hot1 = "#ff4949", hot2 = "#ff6549", 
                                        hot3 ="#ff8049", hot4 = "#ff9c49", hot5 = "#ffb749")) +
  labs(y = "Quantidade de incêndios", x = "Mês", title = 'Quantidade mensal de incêndios',  caption="Fonte: Elaborado pelo Autor") +
    theme(plot.title=element_text(size=10, 
                                  face="bold", 
                                  family="Arial",
                                  hjust=0.5,
                                  lineheight=1.2),  # title
          plot.subtitle=element_text(size=10, 
                                  family="Arial",
                                  face="bold",
                                  hjust=0.5),  # subtitle
          axis.title.x=element_text(size=8),  # X axis title
          axis.title.y=element_text(size=8),  # Y axis title
          axis.text.x=element_text(size=6,
                                   vjust=.5),  # X axis text
          axis.text.y=element_text(size=6),
          legend.title = element_blank(),
          legend.position = "none",
          plot.caption = element_text(size = 8)) # Y axis text
              # ggsave(paste0(path_ch4, "count-byMonth.png"), dpi = "retina", width = 10, height = 8, units = "cm")

rm(temp)
# rm(colors_df)

```


```{r}
data %>% 
  mutate(month = floor_date(date(datahora), "month")) %>% 
  group_by(month, bioma) %>% 
  summarise(n_fires = n()) %>% 
  ggplot(aes(x = month, y = n_fires/1000)) +
  geom_bar(aes(fill = bioma), stat = 'identity') + 
    scale_x_date(date_labels = "%b/%y", date_breaks = "6 months") +
    labs(y = "Focos de incêndios (milhares)", x = "Mês/Ano", title = 'Participação de cada Bioma em incêndios/mês', caption="Fonte: Elaborado pelo Autor") +
    guides(fill = guide_legend(title = "Bioma", override.aes = list(size = 0.5))) +
    theme(plot.title=element_text(size=9, 
                                      face="bold", 
                                      family="Arial",
                                      hjust=0.5,
                                      lineheight=1.2),  # title
              plot.subtitle=element_text(size=9, 
                                         family="Arial",
                                         face="bold",
                                         hjust=0.5),  # subtitle
              axis.title.x=element_text(size=7),  # X axis title
              axis.title.y=element_text(size=7),  # Y axis title
              axis.text.x=element_text(size=5,
                                       vjust=.5),  # X axis text
              axis.text.y=element_text(size=5),
              legend.position=c(1,1), 
              legend.justification=c(0, 1), 
              legend.key.width= unit(0.4, "lines"), 
              legend.key.height = unit(0.4, "lines"),
              plot.margin = unit(c(1, 5, 0.5, 0.5), "lines"),
              legend.title = element_text(size = 4),
              legend.text = element_text(size = 3),
              plot.caption = element_text(size = 6)) + # Y axis text
              ggsave(paste0(path_ch4, "trends-byMonthbyBiomabyYear.png"), dpi = "retina", width = 10, height = 8, units = "cm")
```

In order to plot the number of fires by state, we must do some data wrangling to put the data in the desired format.

```{r}

is.odd <- function(x) x %% 2 != 0
is.even <- function(x) x %% 2 == 0

geo_data <- fromJSON(file = "./geo_data/geo_data_states.json")

maps_df <- list()
  for (i in 1:length(geo_data$features)) {
    coordinates <- unlist(geo_data$features[[i]]$geometry$coordinates[[1]])
    long <- coordinates[is.odd(seq_along(coordinates))]
    lat <-  coordinates[is.even(seq_along(coordinates))]
    
    if(length(long) != length(lat)){
      stop("Wrong subset of coordinate vector", call. = FALSE)
    }
    
    geo_length <- length(long)
    
    estado <- toupper(geo_data$features[[i]]$properties$name)
    codigo <- as.integer(geo_data$features[[i]]$properties$codigo_ibg)
    regiao <- as.integer(geo_data$features[[i]]$properties$regiao_id)
    
    maps_df[[i]] <- as_tibble(
      list(
        estado = rep(stri_trans_general(estado,"Latin-ASCII"), geo_length),
        codigo = rep(codigo, geo_length),
        regiao = rep(regiao, geo_length),
        longitude = long,
        latitude = lat
      )
    )
  }
  
  map_df <- bind_rows(maps_df)
```

```{r}
# the `estado` column of the map dataframe is a character, so in order
# to avoid coertion from factor to character, let's convert it explicitly
data$estado <- as.character(data$estado)
```

```{r}
data %>% 
  select(estado) %>% 
  group_by(estado) %>% 
  summarise(n = n()) %>% 
  right_join(map_df, by = 'estado') %>% 
  ggplot(aes(x = longitude, y = latitude, group = codigo, fill = n/1000)) + 
    geom_polygon() + 
    geom_path(color = 'white', size = 0.1) + 
    scale_fill_continuous(low = "orange", 
                          high = "darkred",
                          name = 'Nº de incêndios (milhares)'
                          ) +
  labs(title = 'Incêndios por Estado', subtitle = "Janeiro/2015 a Setembro/2019", caption="Fonte: Elaborado pelo Autor" ) +
    theme(plot.title=element_text(size=9, 
                                      face="bold", 
                                      family="Arial",
                                      hjust=0.5,
                                      lineheight=1.2),  # title
              plot.subtitle=element_text(size=7, 
                                         family="Arial",
                                         face="bold",
                                         hjust=0.5),  # subtitle
              axis.title = element_blank(),
              axis.text = element_blank(), 
              axis.ticks = element_blank(),
              legend.position=c(1,1), 
              legend.justification=c(0, 1), 
              legend.key.width= unit(0.4, "lines"), 
              legend.key.height = unit(0.4, "lines"),
              plot.margin = unit(c(1, 5, 0.5, 0.5), "lines"),
              legend.title = element_text(size = 4),
              legend.text = element_text(size = 3),
              plot.caption = element_text(size = 6)) +
  ggsave(paste0(path_ch4, "map-byState.png"), dpi = "retina", width = 10, height = 8, units = "cm")
```

As we can see, the state with the most fire ocurrences is Pará in which most of its lands belongs to the amazon ecossystem, this may explain why half the dataset ocurrences comes from Amazon fires.

As we can see below, this trend happens all years.

```{r}

byYear_df <- data %>% 
  select(estado, datahora) %>% 
  mutate(ano = year(datahora)) %>% 
  group_by(estado, ano) %>% 
  summarise(n = n()) %>% 
  right_join(map_df, by = 'estado')

byYear_df %>% 
  ggplot(aes(x = longitude, y = latitude, group = codigo, fill = n/1000)) + 
    geom_polygon() +
    facet_wrap(~ano) +
    geom_path(color = 'white', size = 0.1) + 
    scale_fill_continuous(low = "orange", 
                          high = "darkred",
                          name = 'Números de incêndios\n(milhares)'
                          )  +
  labs(title = 'Incêndios por Estado a cada ano', caption="Fonte: Elaborado pelo Autor" ) +
    theme(plot.title=element_text(size=9, 
                                      face="bold", 
                                      family="Arial",
                                      hjust=0.5,
                                      lineheight=1.2),  # title
              plot.subtitle=element_text(size=7, 
                                         family="Arial",
                                         face="bold",
                                         hjust=0.5),  # subtitle
              axis.title = element_blank(),
              axis.text = element_blank(), 
              axis.ticks = element_blank(),
              legend.position=c(0.7, 0.5), 
              legend.justification=c(0, 1), 
              legend.key.width= unit(0.6, "lines"), 
              legend.key.height = unit(0.6, "lines"),
              legend.title = element_text(size = 6),
              legend.text = element_text(size = 4),
              plot.caption = element_text(size = 6))
  # ggsave(paste0(path_ch4, "map-byStateEachYear.pngx"), dpi = "retina", width = 10, height = 8, units ="cm")

rm(byYear_df)
```

```{r}

top10 <- data %>% 
  group_by(municipio, estado) %>% 
  summarise(n = n()) %>% 
  top_n(1, n) %>% 
  arrange(desc(n))

top10 <- top10[1:10,]
top10 %>% 
  ggplot(aes(x = reorder(municipio, -n), y = n, fill = estado)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = n), 
            size = 2, inherit.aes = T, hjust = 2) +
  coord_flip() +
  labs(title="10 municípios com maior ocorrência de focos de incêndio", subtitle = "em todo o período de Jan/15 a Set/19", y="Nº de incêndios", x= "Município", caption="Fonte: Elaborado pelo Autor") +
  guides(fill = guide_legend(title = "Estado", override.aes = list(size = 0.5))) +
    theme(plot.title=element_text(size=10, 
                                      face="bold", 
                                      family="Arial",
                                      hjust=0.5,
                                      lineheight=1.2),  # title
              plot.subtitle=element_text(size=8, 
                                         family="Arial",
                                         face="bold",
                                         hjust=0.5),  # subtitle
              axis.title.x=element_text(size=8),  # X axis title
              axis.title.y=element_text(size=8),  # Y axis title
              axis.text.x=element_text(size=5,
                                       vjust=.5),  # X axis text
              axis.text.y=element_text(size=4),
              legend.justification=c(0, 1), 
              legend.key.width= unit(0.6, "lines"), 
              legend.key.height = unit(0.6, "lines"),
              legend.title = element_text(size = 6),
              legend.text = element_text(size = 4),
              legend.position = c(0.7, 0.9),
              plot.caption = element_text(size = 6)) + # Y axis text
              ggsave(paste0(path_ch4, "count-byCounty.png"), dpi = "retina", width = 12, height = 8, units = "cm")
```


```{r}
# Sampling 25 percent of the whole data set to make some exploratory graphs
sample <- sample_frac(data, 0.25)

```

```{r}

data %>% 
  select(riscofogo, diasemchuva, precipitacao) %>% 
  filter(data$diasemchuva != 0, data$riscofogo != 0, data$precipitacao != 0) %>% 
ggplot(aes(x=riscofogo, y=precipitacao) ) +
  stat_density_2d(aes(fill = ..density..), geom = "raster", contour = F) +
  scale_fill_distiller(palette=1, direction=1) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  ylim(0, 50) +
  labs(title="Densidade por área", subtitle = "risco de fogo vs. precipitação (mm)", y="Precipitação (mm)", x= "Indíce de risco de fogo", caption="Fonte: Elaborado pelo Autor") +
    theme(plot.title=element_text(size=10, 
                                      face="bold", 
                                      family="Arial",
                                      hjust=0.5,
                                      lineheight=1.2),  # title
              plot.subtitle=element_text(size=8, 
                                         family="Arial",
                                         face="bold",
                                         hjust=0.5),  # subtitle
              axis.title.x=element_text(size=8),  # X axis title
              axis.title.y=element_text(size=8),  # Y axis title
              axis.text.x=element_text(size=5,
                                       vjust=.5),  # X axis text
              axis.text.y=element_text(size=4),
              legend.title = element_blank(),
              legend.text = element_text(size = 4),
              legend.justification=c(0, 1), 
              legend.key.width= unit(0.6, "lines"), 
              legend.key.height = unit(0.6, "lines"),
              legend.position = c(0.9, 0.6),
              plot.caption = element_text(size = 6)) + # Y axis text
              ggsave(paste0(path_ch4, "density-PrecipRiscoFogo.png"), dpi = "retina", width = 12, height = 8, units = "cm")
  
```

```{r}
data %>% 
  ggplot(aes(x = riscofogo, y = precipitacao)) +
  geom_point(alpha = 1/300, na.rm = T ) +
  ylim(0, 50) +
  labs(title="Gráfico de dispersão", subtitle = "risco de fogo vs. precipitação (mm)", y="Precipitação (mm)", x= "Indíce de risco de fogo", caption="Fonte: Elaborado pelo Autor") +
    theme(plot.title=element_text(size=10, 
                                      face="bold", 
                                      family="Arial",
                                      hjust=0.5,
                                      lineheight=1.2),  # title
              plot.subtitle=element_text(size=8, 
                                         family="Arial",
                                         face="bold",
                                         hjust=0.5),  # subtitle
              axis.title.x=element_text(size=8),  # X axis title
              axis.title.y=element_text(size=8),  # Y axis title
              axis.text.x=element_text(size=5,
                                       vjust=.5),  # X axis text
              axis.text.y=element_text(size=4),
              legend.title = element_blank(),
              legend.text = element_text(size = 4),
              legend.justification=c(0, 1), 
              legend.key.width= unit(0.6, "lines"), 
              legend.key.height = unit(0.6, "lines"),
              legend.position = c(0.9, 0.6),
              plot.caption = element_text(size = 6)) + # Y axis text
              ggsave(paste0(path_ch4, "scatter-PrecRiscoFogo.png"), dpi = "retina", width = 12, height = 8, units = "cm")
```



In terms of raw numbers, we can visualize this difference below.

```{r}
data %>% 
  group_by(estado) %>% 
  ggplot(aes(x = factor(estado))) +
    geom_bar() +
    coord_flip()
```

Going down one level, let's try an analysis by county

```{r}
geo_data_counties <- fromJSON(file = "./geo_data/geo_data_counties.json")

maps_df_counties <- list()
  for (i in 1:length(geo_data_counties$features)) {
    coordinates <- unlist(geo_data_counties$features[[i]]$geometry$coordinates[[1]])
    long <- coordinates[is.odd(seq_along(coordinates))]
    lat <-  coordinates[is.even(seq_along(coordinates))]
    
    if(length(long) != length(lat)){
      stop("Wrong subset of coordinate vector", call. = FALSE)
    }
    
    geo_length <- length(long)
    
    municipio <- geo_data_counties$features[[i]]$properties$name
    municipio <- toupper(stri_trans_general(municipio, "Latin-ASCII"))
    codigo <- as.integer(geo_data_counties$features[[i]]$properties$id)
    
    maps_df_counties[[i]] <- as_tibble(
      list(
        municipio = rep(stri_trans_general(municipio, "Latin-ASCII"), geo_length),
        codigo = rep(codigo, geo_length),
        longitude = long,
        latitude = lat
      )
    )
  }
  
  map_df_county <- bind_rows(maps_df_counties)
```

```{r}
data %>% 
  select(municipio) %>% 
  group_by(municipio) %>% 
  summarise(n = n()) %>% 
  right_join(map_df_county, by = 'municipio') %>% 
  ggplot(aes(x = longitude, y = latitude, group = codigo, fill = n)) + 
    geom_polygon() + 
    geom_path(color = 'white', size = 0.1) +
    scale_fill_continuous(low = "orange", 
                          high = "darkred",
                          name = 'Number of fires'
                          ) 
```

What about that total number of fire ocurrences by state? From when does it come from?

```{r}
data %>% 
  mutate(ano = year(datahora)) %>% 
  group_by(estado, ano) %>% 
  ggplot(aes(x = factor(estado), fill = factor(ano))) +
    geom_bar() +
    coord_flip()
```

Let's repeat the last plot, but now considering the proportions

```{r}
data %>% 
  mutate(ano = year(datahora)) %>% 
  group_by(estado, ano) %>% 
  ggplot(aes(x = factor(estado), fill = factor(ano))) +
    geom_bar(position = "fill") +
    coord_flip()
```

Let's reinforce what we've seen by far and plot the data considering a monthly frequency


```{r}
levels <- c("Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro")

data %>% 
  mutate(mes = factor(sapply(months(datahora), capitalize), levels = levels)) %>%
  group_by(mes) %>%
  ggplot(aes(x = factor(mes), y = 100*..prop.., group = 1)) +
    geom_bar()

data %>% 
  mutate(mes = factor(sapply(months(datahora), capitalize), levels = levels),
         ano = factor(year(datahora))) %>%
  group_by(ano, mes) %>%
  ggplot(aes(x = mes, y = 100*..prop.., group = 1)) +
    geom_bar() + 
    facet_wrap(~ano) + coord_flip()
```

As we can see, in 2019 the trend was a bit different, maybe it is so because of the popular protests against the liberal and progressive view of brazilian government towards amazonia.

Strangely, our dataset only has records of fire occurences from 3 to 6 pm. Why is it?

```{r}
data %>% 
  mutate(hour = hour(datahora)) %>% 
  group_by(hour) %>% 
  ggplot(aes(x = hour, group = 1)) +
   geom_bar(stat = "count")
```

O dataframe original não tem informações sobre macro regiões. Utilizando o data frame de mapas, podemos obter esta informação.

```{r}

regionsList <- list()
codMacroRegions <- list()
n_reg <- length(unique(map_df$regiao))
regions <- unique(map_df$regiao)

for(i in 1:n_reg){
  temp <- map_df %>% filter(regiao == regions[i])
  
  states <- unique(temp$estado)
  regionsList[[i]] <- states
  codMacroRegions[[i]] <- regions[i]
}

names(regionsList) <- c("NORTE", "NORDESTE", "SUDESTE", "CENTRO-OESTE", "SUL")

for(i in 1:n_reg){
  data$macroRegiao[data$estado %in% regionsList[[i]]] <- names(regionsList)[i]
  data$codMacroRegiao[data$estado %in% regionsList[[i]]] <- codMacroRegions[[i]]
}
```

```{r}

# O nome regiao do dataframe map_df nao tem o mesmo sentido que no dataframe df
# sendo assim, criou-se um dataframe auxiliar com os nomes correspondentes
temp <- data[,c("macroRegiao", "codMacroRegiao")]
names(temp) <- c("macroregiao", "regiao")

temp %>% 
  group_by(macroregiao, regiao) %>% 
  summarise(n = n()) %>% 
  right_join(map_df, by = 'regiao') %>% 
  ggplot(aes(x = longitude, y = latitude, group = regiao, fill = n/1000)) + 
    geom_polygon() + 
    geom_path(color = 'white', size = 0.1) + 
    scale_fill_continuous(low = "orange", 
                          high = "darkred",
                          name = 'Number of fires\n(thousands)'
                          ) 
```


```{r}
na.omit(data) %>% ggplot(aes(x = frp, y = precipitacao, alpha = riscofogo)) +
  geom_point() +
  xlim(0,500)

na.omit(data) %>% ggplot(aes(x = log(frp), y = precipitacao, alpha = riscofogo)) +
  geom_point()
```

Notice the relationship among the fire radiative power, the precipitation and the risk of fire. It seems that, with more precipitation, the frp is reduced while with less precipitation the risk of fire remains mostly

```{r}
na.omit(data) %>% ggplot(aes(x = riscofogo, y = precipitacao, alpha = frp)) +
  geom_point(position = "jitter")
```

Looking at the distribution of the fire radiative power across different biomas, we can see that it is roughly the same, except for Mata Atlantica and Pampa maybe because Pampa is situated at the south brazil, where temperatures are lower which decreases the chances of fire ocurrences. On the other side, Mata Atlantica is mostly distributed along the coast, implying that the humidity that comes from the ocean may hold fire ocurrences from stroke.

```{r}
na.omit(data) %>% ggplot(aes(x = bioma, y = frp)) +
  geom_boxplot()
```

```{r}
# link for reference https://jfly.uni-koeln.de/color/
# The palette with grey:
cbp1 <- c("#D55E00", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#999999", "#CC79A7")

na.omit(data) %>% ggplot(aes(x = log(frp), col = bioma, fill = bioma)) +
  geom_density(alpha = 0.1) +
  scale_color_manual(values = cbp1) +
  scale_fill_manual(values = cbp1)

```

As we can see below, we cannot take any conclusion about the risk of fire with respect to the fire radiative power. So sad.

```{r}
na.omit(data) %>% 
  ggplot(aes(x = riscofogo, y = log(frp), col = bioma)) +
    geom_point() + # Copy from Plot 1
    geom_smooth(method = "lm", se = TRUE) +
    geom_smooth(aes(group = 1), method = "lm", se = TRUE, linetype = 2) 
```

One thing we did not show yet was the geographical distribution of fire points through the years. Put on your belts and enjoy the folowing two plots!

```{r}
# Segmenting Data To plot accordingly to the period available for 2019
data15 <- data %>% filter(year(datahora) == '2015')
data16 <- data %>% filter(year(datahora) == '2016')
data17 <- data %>% filter(year(datahora) == '2017')
data18 <- data %>% filter(year(datahora) == '2018')
data19 <- data %>% filter(year(datahora) == '2019')

data_partial <- data %>% 
  filter(month(datahora) >= 1,
         month(datahora) <= 9) %>% 
  mutate(ano = year(datahora))
```

In addition, let's focus on the legal amazon area.

```{r}
shape <- read_sf(dsn = "./geo_data/legal_amazon_simple", layer = "UF_AMLeg_LLwgs84_Simple")

# Shapefile of amazon legal area can also be obtained at http://www.dpi.inpe.br/Ambdata/unidades_administrativas.php

shapeINPE <- read_sf(dsn = "./geo_data/AmLeg_LLwgs84", layer = "amazlegal")
```

```{r}
legal_amazon <- as.data.frame(shape$geometry[[1]][[1]])
names(legal_amazon) <- c("longitude", "latitude")

legal_amazon_INPE <- as.data.frame(shapeINPE$geometry[[1]][[1]][[1]])
names(legal_amazon_INPE) <- c("longitude", "latitude")

legal_amazon %>% ggplot(aes(x = longitude, y = latitude)) +
  geom_polygon()

legal_amazon_INPE %>% ggplot(aes(x = longitude, y = latitude)) +
  geom_polygon()

# To see if a point is inside a polygon
# point.in.polygon(-60, -5, shape$geometry[[1]][[1]][,1], shape$geometry[[1]][[1]][,2])
```

How much of the dataset is inside the legal amazon area (from january to september)

```{r}

dfs <- list(data15, data16, data17, data18, data19)
scores <- c()
for (i in 1:5) {
  scores[i] <- paste("Observations detected inside the legal amazon in", unique(year(dfs[[i]]$datahora)), "are",
      round(sum(point.in.polygon(dfs[[i]]$longitude, dfs[[i]]$latitude, shape$geometry[[1]][[1]][,1], shape$geometry[[1]][[1]][,2])) / nrow(dfs[[i]]), 2))
}
writeLines(scores)

rm(dfs)
rm(scores)
```


```{r}
# Only for 2019

data %>% 
  select(estado) %>% 
  group_by(estado) %>% 
  summarise(n = n()) %>% 
  right_join(map_df, by = 'estado') %>% 
  ggplot(aes(x = longitude, y = latitude, group = codigo)) + 
    geom_polygon() + 
    geom_point(inherit.aes = F, data = data19, aes(x = longitude, y = latitude, col = bioma), size = 0.1, shape = 21, alpha = 1/20) +
    scale_color_manual(values = cbp1) +
    geom_path(color = 'white', size = 0.1) +
    geom_path(inherit.aes = F, data = legal_amazon_INPE, mapping = aes(x = longitude, y = latitude), color = "yellow") +
    geom_dl(aes(label = "Amazônia Legal"), method = list(dl.combine("last.points"), cex = 0.6, hjust = 3, vjust = -14)) +
  guides(colour = guide_legend(title = "Bioma", override.aes = list(alpha = 1))) +
    # facet_wrap(~ano) +
  labs(title = 'Distribuição espacial de focos de incêndios', subtitle = "Entre Janeiro e Setembro de 2019", caption="Fonte: Elaborado pelo Autor" ) +
    theme(plot.title=element_text(size=9, 
                                      face="bold", 
                                      family="Arial",
                                      hjust=0.5,
                                      lineheight=1.2),  # title
              plot.subtitle=element_text(size=7, 
                                         family="Arial",
                                         face="bold",
                                         hjust=0.5),  # subtitle
              axis.title = element_blank(),
              axis.text = element_blank(), 
              axis.ticks = element_blank(),
              legend.position=c(0.1, 0.45), 
              legend.justification=c(0, 1), 
              legend.key.width= unit(0.6, "lines"), 
              legend.key.height = unit(0.6, "lines"),
              legend.title = element_text(size = 7),
              legend.text = element_text(size = 5),
              plot.caption = element_text(size = 6)) 
                # ggsave(paste0(path_ch4, "amazon2019.png"), dpi = "retina", width = 10, height = 8, units = "cm")
rm(data19)
```


It is worth noting not only the distribution of point occurrences in 2019 but also through all years involved in the analysis process

```{r}
# For all years

data %>% 
  select(estado) %>% 
  group_by(estado) %>% 
  summarise(n = n()) %>% 
  right_join(map_df, by = 'estado') %>% 
  ggplot(aes(x = longitude, y = latitude, group = codigo)) + 
    geom_polygon() + 
    geom_point(inherit.aes = F, data = data_partial, aes(x = longitude, y = latitude, col = bioma), size = 0.01, shape = 21, alpha = 1/50) +
    scale_color_manual(values = cbp1) +
    geom_path(color = 'white', size = 0.1) +
    geom_path(inherit.aes = F, data = legal_amazon_INPE, mapping = aes(x = longitude, y = latitude), color = "yellow") +
    geom_dl(aes(label = "Amazônia Legal"), method = list(dl.combine("last.points"), cex = 0.6, hjust = 3, vjust = -14)) +
  guides(colour = guide_legend(title = "Bioma", override.aes = list(alpha = 1))) +
    facet_wrap(~ano) +
  labs(title = 'Distribuição espacial de focos de incêndios', subtitle = "Entre Janeiro e Setembro", caption="Fonte: Elaborado pelo Autor" ) +
    theme(plot.title=element_text(size=9, 
                                      face="bold", 
                                      family="Arial",
                                      hjust=0.5,
                                      lineheight=1.2),  # title
              plot.subtitle=element_text(size=7, 
                                         family="Arial",
                                         face="bold",
                                         hjust=0.5),  # subtitle
              axis.title = element_blank(),
              axis.text = element_blank(), 
              axis.ticks = element_blank(),
              legend.position=c(0.7, 0.5),  
              legend.justification=c(0, 1), 
              legend.key.width= unit(0.6, "lines"), 
              legend.key.height = unit(0.6, "lines"),
              legend.title = element_text(size = 7),
              legend.text = element_text(size = 5),
              plot.caption = element_text(size = 6)) 
                # ggsave(paste0(path_ch4, "amazon-allYears.png"), dpi = "retina", width = 10, height = 8, units = "cm")

rm(data_partial)
```

What about cumulative sums?

```{r}
accum_fires_inpe <- data %>%
  mutate(data = date(datahora),
         ano = year(datahora)) %>% 
  select(ano, data) %>% 
  group_by(ano, data) %>% 
  summarise(occurrence = n()) %>% 
  mutate(cum_sum = cumsum(occurrence),
         dia_ano = yday(data))

accum_fires_inpe %>% ggplot(aes(x = data, y = cum_sum)) +
  geom_line() +
  scale_x_date(date_breaks = "4 months", date_labels = "%b/%y")
```

```{r}
splitted <- accum_fires_inpe %>% select(ano, dia_ano, cum_sum)

# Using `do` function to replace NAs values with the last records value
tidy <- splitted %>% spread(key = ano, value = cum_sum) %>% do(zoo::na.locf(.))
tidy$`2019`[273:nrow(tidy)] <- NA
tidy <- tidy %>% 
  gather("2015", "2016", "2017", "2018", "2019", key = "year", "value" = fires)
  
```

```{r}
tidy %>% 
  ggplot(aes(x = dia_ano, y = fires, col = year)) +
  geom_line() +
  scale_color_manual(values = c("grey", "grey", "grey", "grey", "blue")) +
  scale_x_continuous("Day of the year", breaks = seq(from = 0, to = 366, by = 50)) +
  scale_y_continuous("Number of fires")
```


---------------------------------------------- FIRMS DATA -------------------------------------  


As seen before, our dataset lacks of 70% information about the fire radiative power of fires. In order to analyze this variable with confident outcomes, we need other data sources. From data collected from Nasa Modis project it is possible to enhance the analysis with much more data.

```{r}
# Find the documentation at https://earthdata.nasa.gov/earth-observation-data/near-real-time/firms/active-fire-data
# Load standard science quality data (before 1st aug/19)
nasaModis1 <-  read.csv("./database/DL_FIRE_M6_79475/fire_archive_M6_79475.csv")

# Load NRT  (after 1st aug/19)
nasaModis2 <- read.csv("./database/DL_FIRE_M6_79475/fire_nrt_M6_79475.csv")
```

```{r}
str(nasaModis1)
```

```{r}
str(nasaModis2)
```

In order to accomplish an accurate analysis in this dataset, we need to filter some rows. By doing so, we can get close to the data quality of INPE's dataset.

First of all, the type describes the Inferred hot spot type and assumes 4 values: 0 (presumed vegetation fire), 1 (active volcano), 2 (other statis land source), 3 (offshore). Therefore, we're going the filter the data for type = 0.

Another important thing to note is the confidence variable. This value is based on a collection of intermediate algorithm quantities used in the detection process. It is intended to help users gauge the quality of individual hotspot/fire pixels. Confidence estimates range between 0 and 100% and are assigned one of the three fire classes (low-confidence fire, nominal-confidence fire, or high-confidence fire).

As a consequence, I am going to consider only the records with more than 50% of confidence. 

Additionally, notice that the non-standard science quality dataset has no information about the type of the fire. Let's assume all fires from these bunch are vegetation fires. With this, to bind the two datasets, we need to filter the nasaModis1 to get only type 0 fires and then drop this column since the nasaModis2 does not have this variable.

```{r}
nasaModis1 <- nasaModis1 %>% filter(type == 0)
nasaModis1$type <- NULL

nasaModis2$version <- as.numeric(nasaModis2$version)

nasaModis <- bind_rows(nasaModis1, nasaModis2)

firms <- nasaModis %>% 
  filter(confidence > 50)
```

the acq_date variable is of type factor, it needs to be converted to a standard date type;

```{r}
firms$acq_date <- as.Date(firms$acq_date) 
```

The filtered data corresponds to 78.3% of the whole dataset. By the summary statistics of the data, we clearly don't need the columns satellite, instrument, version and type. In addition, the scan and track columns do not provide us with useful information. Hence, they will also be forget.

```{r}
firms[,c("scan", "track", "satellite", "instrument", "version", "type")] <- NULL
head(firms)
```

Let's a plot like the acummulated fires vs day of the year, and also accumulated frp vs day of the year

```{r}
accum_fires_nasa <- firms %>%
  mutate(acq_year = year(acq_date)) %>% 
  select(acq_year, acq_date) %>% 
  group_by(acq_year, acq_date) %>% 
  summarise(occurrences = n()) %>% 
  mutate(cum_sum = cumsum(occurrences),
         day_year = yday(acq_date))
```

```{r}
accum_fires_nasa %>% ggplot(aes(x = acq_date, y = cum_sum / 1000)) +
  geom_line() +
  scale_x_date(date_breaks = "4 months", date_labels = "%b/%y") +
  labs(title="Curva cumulativa de incêndios por dia", y="Quantidade acumulada de incêndios (milhares)", x= "Mês/Ano", caption="Fonte: Elaborado pelo Autor") +
    theme(plot.title=element_text(size=10, 
                                      face="bold", 
                                      family="Arial",
                                      hjust=0.5,
                                      lineheight=1.2),  # title
              plot.subtitle=element_text(size=8, 
                                         family="Arial",
                                         face="bold",
                                         hjust=0.5),  # subtitle
              axis.title.x=element_text(size=8),  # X axis title
              axis.title.y=element_text(size=8),  # Y axis title
              axis.text.x=element_text(size=5,
                                       vjust=.5),  # X axis text
              axis.text.y=element_text(size=4),
              # legend.title = element_blank(),
              legend.text = element_text(size = 4),
              legend.justification=c(0, 1), 
              legend.key.width= unit(0.6, "lines"), 
              legend.key.height = unit(0.6, "lines"),
              legend.position = c(0.9, 0.6),
              plot.caption = element_text(size = 6))  +# Y axis text
              ggsave(paste0(path_ch4, "cumulativeFire.png"), dpi = "retina", width = 12, height = 8, units = "cm")
```

Wrangling data to plot accumulated fires vs day of the year

```{r}
splitted <- accum_fires_nasa %>% select(acq_year, day_year, cum_sum)

# Using `do` function to replace NAs values with the last records value
tidy <- splitted %>% spread(key = acq_year, value = cum_sum) %>% do(zoo::na.locf(.))
tidy$`2019`[273:nrow(tidy)] <- NA
tidy <- tidy %>% 
  gather("2015", "2016", "2017", "2018", "2019", key = "acq_year", "value" = fires)
  
```


```{r}

tidy %>% 
  ggplot(aes(x = day_year, y = fires / 1000, col = acq_year)) +
  geom_line(size = .7, alpha = .8) +
  scale_color_manual(values = c("#ff4949", "#ff9c49", "#ff6549", "#ffb749", "#300836")) +
  scale_x_continuous(breaks = seq(from = 0, to = 366, by = 50)) +
  geom_dl(aes(label = acq_year), method = list(dl.combine("last.points"), cex = 0.5, hjust = .6, vjust = -.8)) +
  labs(title="Curva cumulativa de poder radiativo de fogo emitido", subtitle = "por dia do ano", y="Poder radiativo emitido acumulado (gigawatt)", x= "Dia do ano", caption="Fonte: Elaborado pelo Autor") +
    theme(plot.title=element_text(size=10, 
                                      face="bold", 
                                      family="Arial",
                                      hjust=0.5,
                                      lineheight=1.2),  # title
              plot.subtitle=element_text(size=8, 
                                         family="Arial",
                                         face="bold",
                                         hjust=0.5),  # subtitle
              axis.title.x=element_text(size=8),  # X axis title
              axis.title.y=element_text(size=8),  # Y axis title
              axis.text.x=element_text(size=5,
                                       vjust=.5),  # X axis text
              axis.text.y=element_text(size=4),
              legend.title = element_blank(),
              legend.text = element_blank(),
              legend.justification=c(0, 1), 
              legend.key.width= unit(0.6, "lines"), 
              legend.key.height = unit(0.6, "lines"),
              legend.position = "none",
              plot.caption = element_text(size = 6)) + # Y axis text
              ggsave(paste0(path_ch4, "frpbyDay.png"), dpi = "retina", width = 12, height = 8, units = "cm")
```

Now let's wrap over the frp variable

```{r}
accum_frp_nasa <- firms %>%
  mutate(acq_year = year(acq_date)) %>% 
  select(acq_year, acq_date, frp) %>% 
  group_by(acq_year, acq_date) %>% 
  summarise(frp = sum(frp)) %>% 
  mutate(cum_frp = cumsum(frp),
         day_year = yday(acq_date))
```

```{r}
accum_frp_nasa %>% ggplot(aes(x = acq_date, y = cum_frp/1000000)) +
  geom_line() +
  scale_x_date(date_breaks = "4 months", date_labels = "%b/%y")
```

------------------------- SPATIAL ANALYSIS

```{r}
ggplot()
```


The result for FIRMS corroborate with those from INPE.

One thing that we do not see until this point was the average fire radiative power along the days of the year. However, as we have many extreme cases, i.e., outliers, we are gonna remove them before plotting the statistics

```{r}

q1 <- quantile(firms$frp, .25)
q3 <- quantile(firms$frp, .75)
iqr <- IQR(firms$frp)

mild_low <- q1 - 1.5 * iqr
mild_high <- q3 + 1.5 * iqr

clean_modis <- firms[firms$frp > mild_low & firms$frp < mild_high, ] #rows

mean_frp_nasa <- clean_modis %>%
  mutate(acq_year = year(acq_date),
         acq_week = week(acq_date)) %>% 
  select(acq_year, acq_week, frp) %>% 
  group_by(acq_year, acq_week) %>% 
  summarise(mean_frp = mean(frp))
```

```{r}
splitted <- mean_frp_nasa %>% select(acq_year, acq_week, mean_frp)

# Using `do` function to replace NAs values with the last records value
tidy <- splitted %>% spread(key = acq_year, value = mean_frp) %>% do(zoo::na.locf(.))
tidy$`2019`[40:nrow(tidy)] <- NA
tidy <- tidy %>% 
  gather("2015", "2016", "2017", "2018", "2019", key = "acq_year", "value" = mean_frp)
```

```{r}
tidy %>% 
  ggplot(aes(x = acq_week, y = mean_frp, col = acq_year)) +
  geom_line() +
  scale_color_manual(values = c("grey", "grey", "grey", "grey", "red")) +
  scale_x_continuous("Week of the year", breaks = seq(from = 0, to = 52, by = 4)) +
  scale_y_continuous("Fire Radiative power")
```

```{r}
clean_modis %>% 
  group_by(acq_date) %>% 
  summarise(mean_frp = mean(frp)) %>% 
  ggplot(aes(x = acq_date, y = mean_frp)) +
  geom_line() +
  scale_x_date(date_breaks = "4 months", date_labels = "%b/%y")
```

this graph shows that there 9s a strong seasonality in the mean of the fire radiative power which has strongs components of periods Ts = 360 and Ts = 180 (Ts = sampling period).

Let's investigate the fires of the Amazonia during the fire season:

Cumulative active fire detections from May 1st through October 1st from MODIS (Aqua + Terra) and VIIRS (SNPP) show that fire detections in 2019 have fallen below cumulative levels of fire activity detected in 2012 (the start of the VIIRS record) and 2017 across the Legal Amazon. Through the end of September, fires in 2019 were more intense than any year since 2012, measured in terms of fire radiative power, consistent with the observed increase in deforestation this year.

```{r}
modis_fcount <- read.csv("./database/legal_amazon_fc_frp_20191001/Table_MODIS_fire_counts_2003_2019.csv")
```

```{r}
tidy_modis_fcount <- modis_fcount %>% 
  gather(-`DOY`, key = "year", "value" = fires)

tidy_modis_fcount$year <- as.integer(substr(tidy_modis_fcount$year, 2, 5))
tidy_modis_fcount$fires <- as.integer(tidy_modis_fcount$fires)

```

```{r}
ggplotly(tidy_modis_fcount %>% 
  ggplot(aes(x = DOY, y = fires, color = factor(year))) +
  geom_line())
```

```{r}
modis_avg_frp <- read.csv("./database/legal_amazon_fc_frp_20191001/Table_MODIS_fire_radiative_power_2003_2019.csv")
```

```{r}
tidy_modis_avg_frp <- modis_avg_frp %>% 
  gather(-`DOY`, key = "year", "value" = fires)

tidy_modis_avg_frp$year <- as.integer(substr(tidy_modis_avg_frp$year, 2, 5))
tidy_modis_avg_frp$fires <- as.integer(tidy_modis_avg_frp$fires)
```

```{r}
ggplotly(
  tidy_modis_avg_frp %>% 
  ggplot(aes(x = DOY, y = fires, color = factor(year))) +
  geom_line()
)
```



From NasaPower API we can obtain useful data for about 146 weather and climate parameters, such as:

Relative humidty (at two meters)
Temperature (at two meters)
Precipitation (mm)
Maximum/Minimum Monthly Difference From Monthly Averaged All Sky Insolation
Wind Speed 

geographical data are provided at the resolution of 1/2 arc degree longitude by 1/2 arc degree latitude. for more detailed info go to https://power.larc.nasa.gov/documents/POWER_Data_v9_methodology.pdf

Another useful resource can be found at https://earthobservatory.nasa.gov/images/145464/fires-in-brazil

Also in https://www.globalfiredata.org/data.html we can find data such as carbon emissions and dry matter emissions.

For highly personalizable images go to https://worldview.earthdata.nasa.gov/

Detailed information about fires on the Legal Amazon area is given at http://www.globalfiredata.org/forecast.html#amazonas

Thoughts on fire forecasting https://www.nasa.gov/feature/goddard/2019/fire-forecasting-from-smart-phone-in-wilderness

Wildfires against biodiversity https://onlinelibrary.wiley.com/doi/abs/10.1111/btp.12267 and
https://link.springer.com/article/10.1007/s10531-012-0426-8




